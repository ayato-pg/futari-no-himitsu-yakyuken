<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2人の秘密、野球拳。</title>
    <link rel="stylesheet" href="./src/styles/main.css?v=1.5.6">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;700&display=swap" rel="stylesheet">
</head>
<body>
    <div id="game-container">
        <!-- ローディング画面 -->
        <div id="loading-screen" class="screen active">
            <div class="loading-content">
                <h1>2人の秘密、野球拳。</h1>
                <div class="loading-spinner"></div>
                <p>Loading...</p>
            </div>
        </div>

        <!-- タイトル画面 -->
        <div id="title-screen" class="screen">
            <div class="background" id="title-bg"></div>
            <div class="title-content">
                <!-- 左側：美咲の立ち絵表示エリア -->
                <div class="misaki-display">
                    <img id="misaki-title" src="assets/images/characters/misaki/misaki_adult_normal.png" alt="美咲お姉ちゃん">
                </div>

                <!-- 右側：タイトルとメニュー -->
                <div class="title-main-content">
                    <div class="game-logo">
                        <h1>2人の秘密、野球拳。</h1>
                        <div class="subtitle">～大人になった二人の秘密～</div>
                    </div>
                    
                    <div class="menu-buttons">
                        <button class="game-btn" id="btn-new-game">はじめる</button>
                        <button class="game-btn" id="btn-howtoplay">遊び方</button>
                        <button class="game-btn" id="btn-gallery" disabled>ギャラリー</button>
                        <button class="game-btn" id="btn-settings">設定</button>
                        <button class="game-btn dev-btn" id="btn-csv-reload" style="background: #ff6b7d !important; font-size: 0.9em !important; display: block !important; visibility: visible !important; opacity: 1 !important; position: relative !important; z-index: 999 !important;">CSV更新</button>
                        <button class="game-btn dev-btn" id="btn-bad-end-editor" style="background: #9B59B6 !important; color: white !important; font-size: 0.9em !important; display: block !important; visibility: visible !important; opacity: 1 !important; position: relative !important; z-index: 999 !important; margin: 10px 0 !important; padding: 15px 30px !important; border: none !important; border-radius: 25px !important; cursor: pointer !important; font-weight: bold !important;">BAD END編集</button>
                        <button class="game-btn dev-btn" id="btn-show-bad-end" style="background: #E74C3C !important; color: white !important; font-size: 0.9em !important; display: block !important; visibility: visible !important; opacity: 1 !important; position: relative !important; z-index: 999 !important; margin: 10px 0 !important; padding: 15px 30px !important; border: none !important; border-radius: 25px !important; cursor: pointer !important; font-weight: bold !important;">BAD END表示</button>
                        <button class="game-btn dev-btn" id="btn-clear-cache" style="background: #F39C12 !important; color: white !important; font-size: 0.9em !important; display: block !important; visibility: visible !important; opacity: 1 !important; position: relative !important; z-index: 999 !important; margin: 10px 0 !important; padding: 15px 30px !important; border: none !important; border-radius: 25px !important; cursor: pointer !important; font-weight: bold !important;">キャッシュクリア</button>
                        <button class="game-btn dev-btn" id="btn-victory-talk" style="background: #27AE60 !important; color: white !important; font-size: 0.9em !important; display: block !important; visibility: visible !important; opacity: 1 !important; position: relative !important; z-index: 999 !important; margin: 10px 0 !important; padding: 15px 30px !important; border: none !important; border-radius: 25px !important; cursor: pointer !important; font-weight: bold !important;">🏆エンディングトーク</button>
                        <button class="game-btn dev-btn" id="btn-game-over-editor" style="background: #8E44AD !important; color: white !important; font-size: 0.9em !important; display: block !important; visibility: visible !important; opacity: 1 !important; position: relative !important; z-index: 999 !important; margin: 10px 0 !important; padding: 15px 30px !important; border: none !important; border-radius: 25px !important; cursor: pointer !important; font-weight: bold !important;">🛠️終了画面編集</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 会話シーン -->
        <div id="dialogue-screen" class="screen">
            <div class="background" id="dialogue-bg"></div>
            <button class="return-to-title-btn" id="dialogue-return-btn">タイトルへ戻る</button>
            <div class="misaki-large-display">
                <img id="misaki-dialogue" src="assets/images/characters/misaki/misaki_dialogue_normal.png" alt="美咲">
            </div>
            <div class="dialogue-box">
                <div class="character-name">美咲</div>
                <div class="dialogue-text" id="dialogue-text"></div>
                <div class="dialogue-controls">
                    <button class="control-btn" id="btn-skip">Skip</button>
                    <button class="control-btn" id="btn-auto">Auto</button>
                    <button class="control-btn" id="btn-log">Log</button>
                    <button class="control-btn" id="btn-save">Save</button>
                    <button class="control-btn" id="btn-menu">Menu</button>
                </div>
            </div>
        </div>

        <!-- メインゲーム画面 -->
        <div id="game-screen" class="screen">
            <div class="background" id="game-bg"></div>
            <button class="return-to-title-btn" id="game-return-btn">タイトルへ戻る</button>
            
            <!-- 上部ステータス -->
            <div class="status-top">
                <div class="round-info">ラウンド <span id="current-round">1</span>/9</div>
                <div class="win-condition">勝利条件: 5勝先取</div>
            </div>

            <!-- 美咲のハート表示（ラウンド表示の下） -->
            <div class="misaki-hearts-display" id="misaki-hearts-display">
                <div class="hearts-container" id="misaki-hearts-container"></div>
            </div>

            <!-- 美咲のステータスとHP -->
            <div class="misaki-status">
                <div class="character-name">美咲</div>
                <div class="hp-display">
                    <div class="hp-bar-container">
                        <div class="hp-bar-label">ライフ</div>
                        <div class="hp-bar">
                            <div class="hp-bar-fill" id="misaki-hp-bar"></div>
                            <div class="hp-bar-text" id="misaki-hp-text">5/5</div>
                        </div>
                    </div>
                    <div class="defeat-count">敗北数: <span id="misaki-defeats">0</span></div>
                </div>
            </div>

            <!-- 美咲の大型立ち絵表示 -->
            <div class="misaki-game-display">
                <img id="misaki-game" src="assets/images/characters/misaki/misaki_game_stage1.png" alt="美咲">
            </div>

            <!-- ゲーム開始前の会話とボタン -->
            <div class="game-intro" id="game-intro">
                <div class="intro-dialogue" id="intro-dialogue">
                    <div class="dialogue-text" id="game-dialogue-text">
                        <!-- タイプライター効果で表示されます -->
                    </div>
                </div>
                <button class="start-game-btn" id="start-game-btn">ゲーム開始</button>
            </div>

            <!-- バトル結果表示 -->
            <div class="battle-result" id="battle-result">
                <div class="result-text" id="result-text"></div>
                <div class="hands-display">
                    <div class="hand-result">美咲: <span id="misaki-hand"></span></div>
                    <div class="vs">VS</div>
                    <div class="hand-result">あなた: <span id="player-hand"></span></div>
                </div>
            </div>

            <!-- じゃんけんアニメーション表示 -->
            <div class="janken-animation" id="janken-animation">
                <div class="animation-overlay"></div>
                <div class="hands-battle">
                    <div class="player-hand-display">
                        <div class="hand-label">あなた</div>
                        <div class="hand-image" id="player-hand-image">
                            <img src="" alt="" id="player-hand-img">
                        </div>
                        <div class="hand-effect" id="player-hand-effect"></div>
                    </div>
                    <div class="vs-display">
                        <div class="vs-text" id="vs-text">VS</div>
                        <div class="battle-sparks"></div>
                        <div class="impact-burst" id="impact-burst"></div>
                    </div>
                    <div class="misaki-hand-display">
                        <div class="hand-label">美咲</div>
                        <div class="hand-image" id="misaki-hand-image">
                            <img src="" alt="" id="misaki-hand-img">
                        </div>
                        <div class="hand-effect" id="misaki-hand-effect"></div>
                    </div>
                </div>
                <div class="result-display" id="animated-result">
                    <div class="result-text-animated" id="result-text-animated"></div>
                    <div class="result-subtitle" id="result-subtitle"></div>
                </div>
            </div>

            <!-- プレイヤーのステータス -->
            <div class="player-status">
                <div class="character-name">あなた</div>
                <div class="hp-display">
                    <div class="hp-bar-container">
                        <div class="hp-bar-label">ライフ</div>
                        <div class="hp-bar">
                            <div class="hp-bar-fill player-hp" id="player-hp-bar"></div>
                            <div class="hp-bar-text" id="player-hp-text">5/5</div>
                        </div>
                    </div>
                    <div class="victory-count">勝利数: <span id="player-victories">0</span></div>
                </div>
            </div>

            <!-- プレイヤーのハート表示（じゃんけんボタンの上） -->
            <div class="player-hearts-display" id="player-hearts-display">
                <div class="hearts-container" id="player-hearts-container"></div>
            </div>

            <!-- じゃんけん選択ボタン -->
            <div class="janken-controls">
                <div class="hand-buttons">
                    <button class="hand-btn" id="btn-rock">
                        <img src="assets/images/ui/rock.png" alt="グー">
                        <span>グー</span>
                    </button>
                    <button class="hand-btn" id="btn-scissors">
                        <img src="assets/images/ui/scissors.png" alt="チョキ">
                        <span>チョキ</span>
                    </button>
                    <button class="hand-btn" id="btn-paper">
                        <img src="assets/images/ui/paper.png" alt="パー">
                        <span>パー</span>
                    </button>
                </div>
                <!-- 進めるボタン（初期は非表示） -->
                <div class="advance-button-container" style="display: none;">
                    <button class="hand-btn advance-btn" id="btn-advance">
                        <span style="font-size: 2em;">▶️</span>
                        <span>進める</span>
                    </button>
                </div>
                <div class="instruction">選択してください</div>
            </div>

            <!-- ゲーム制御ボタン -->
            <div class="game-controls">
                <button class="control-btn" id="btn-hint">ヒント</button>
                <button class="control-btn" id="btn-surrender">降参</button>
            </div>
        </div>

        <!-- エンディング画面 -->
        <div id="ending-screen" class="screen">
            <div class="background" id="ending-bg"></div>
            <button class="return-to-title-btn" id="ending-return-btn">タイトルへ戻る</button>
            <div class="ending-content">
                <div class="ending-title" id="ending-title"></div>
                <div class="ending-character">
                    <img id="ending-character-sprite" src="" alt="立ち絵" style="display: none;">
                </div>
                <div class="ending-cg">
                    <img id="ending-image" src="" alt="エンディング">
                </div>
                <div class="ending-text" id="ending-text"></div>
                <div class="ending-controls">
                    <button class="game-btn" id="btn-title-return">タイトルに戻る</button>
                    <button class="game-btn" id="btn-replay">もう一度プレイ</button>
                </div>
            </div>
        </div>

        <!-- BAD END編集画面 -->
        <div id="bad-end-editor-screen" class="screen" style="z-index: 9999;">
            <div class="background" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></div>
            <button class="return-to-title-btn" id="editor-return-btn" style="position: absolute; top: 20px; right: 20px; z-index: 10000;">タイトルへ戻る</button>
            <div class="editor-content" style="padding: 20px; overflow-y: auto; height: 100vh; box-sizing: border-box;">
                <h2 style="color: white; text-align: center; margin-bottom: 30px; font-size: 2em;">BAD END テキスト編集</h2>
                
                <div class="editor-form" style="background: rgba(255,255,255,0.95); padding: 30px; border-radius: 10px; max-width: 800px; margin: 0 auto;">
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: bold; margin-bottom: 5px;">タイトルテキスト:</label>
                        <input type="text" id="bad-end-title" style="width: 100%; padding: 10px; font-size: 16px; border: 2px solid #ddd; border-radius: 5px;">
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: bold; margin-bottom: 5px;">冒頭テキスト:</label>
                        <textarea id="bad-end-opening" style="width: 100%; padding: 10px; font-size: 16px; border: 2px solid #ddd; border-radius: 5px; min-height: 60px;"></textarea>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: bold; margin-bottom: 5px;">美咲のリアクション:</label>
                        <textarea id="bad-end-reaction" style="width: 100%; padding: 10px; font-size: 16px; border: 2px solid #ddd; border-radius: 5px; min-height: 60px;"></textarea>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: bold; margin-bottom: 5px;">美咲のセリフ (特別テキスト):</label>
                        <input type="text" id="bad-end-special" style="width: 100%; padding: 10px; font-size: 16px; border: 2px solid #ddd; border-radius: 5px;">
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: bold; margin-bottom: 5px;">子供時代の振り返り:</label>
                        <textarea id="bad-end-childhood" style="width: 100%; padding: 10px; font-size: 16px; border: 2px solid #ddd; border-radius: 5px; min-height: 60px;"></textarea>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: bold; margin-bottom: 5px;">次回への誘い:</label>
                        <input type="text" id="bad-end-invitation" style="width: 100%; padding: 10px; font-size: 16px; border: 2px solid #ddd; border-radius: 5px;">
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: bold; margin-bottom: 5px;">締めの印象:</label>
                        <textarea id="bad-end-impression" style="width: 100%; padding: 10px; font-size: 16px; border: 2px solid #ddd; border-radius: 5px; min-height: 60px;"></textarea>
                    </div>
                    
                    <div class="editor-controls" style="display: flex; gap: 15px; justify-content: center; margin-top: 30px; flex-wrap: wrap;">
                        <button class="game-btn" id="btn-save-bad-end" style="background: #27AE60; color: white; padding: 12px 24px; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; min-width: 100px;">💾 保存</button>
                        <button class="game-btn" id="btn-reset-bad-end" style="background: #E74C3C; color: white; padding: 12px 24px; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; min-width: 100px;">🔄 リセット</button>
                        <button class="game-btn" id="btn-preview-bad-end" style="background: #3498DB; color: white; padding: 12px 24px; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; min-width: 100px;">👁️ プレビュー</button>
                        <button class="game-btn" id="btn-load-csv-bad-end" style="background: #9B59B6; color: white; padding: 12px 24px; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; min-width: 100px;">📂 CSV読み込み</button>
                    </div>
                </div>
                
                <div id="preview-area" style="display: none; background: rgba(0,0,0,0.8); color: white; padding: 30px; border-radius: 10px; max-width: 800px; margin: 20px auto;">
                    <h3 style="color: #ff6b7d; margin-bottom: 20px;">プレビュー</h3>
                    <div id="preview-content" style="white-space: pre-wrap; line-height: 1.8;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="src/systems/CSVLoader.js"></script>
    <script src="src/systems/SaveSystem.js"></script>
    <script src="src/systems/AudioManager.js"></script>
    <script src="src/systems/CostumeSystem.js"></script>
    <script src="src/systems/ClickAreaSystem.js"></script>
    <script src="src/scenes/TitleScene.js"></script>
    <script src="src/scenes/DialogueScene.js"></script>
    <script src="src/scenes/GameScene.js"></script>
    <script src="src/scenes/EndingScene.js"></script>
    <script src="src/scenes/BadEndEditorScene.js"></script>
    <script src="src/scenes/GameOverEditorScene.js"></script>
    <script src="src/game.js"></script>
    
    <!-- 🏆 エンディングトークボタンの直接実装 -->
    <script>
        // ゲーム初期化後にボタン機能を追加
        document.addEventListener('DOMContentLoaded', function() {
            // 1秒後にボタン機能を設定（ゲーム初期化待ち）
            setTimeout(function() {
                const victoryTalkBtn = document.getElementById('btn-victory-talk');
                
                if (victoryTalkBtn) {
                    console.log('🏆 エンディングトークボタンを直接設定');
                    
                    victoryTalkBtn.addEventListener('click', function(event) {
                        event.preventDefault();
                        event.stopPropagation();
                        
                        console.log('🏆 エンディングトークボタンがクリックされました');
                        
                        // 効果音再生
                        if (window.gameController && window.gameController.audioManager) {
                            window.gameController.audioManager.playSE('se_click.mp3', 0.7).catch(() => {});
                        }
                        
                        // ゲームコントローラーが初期化されているか確認
                        if (window.gameController && window.gameController.isInitialized) {
                            showVictoryTalkDirectly();
                        } else {
                            console.warn('ゲームコントローラーが未初期化です');
                            alert('ゲームがまだ読み込み中です。しばらくお待ちください。');
                        }
                    });
                    
                    console.log('✅ エンディングトークボタンの直接実装完了');
                } else {
                    console.warn('❌ エンディングトークボタンが見つかりません');
                }
                
                // 🛠️ ゲーム終了画面編集ボタンの直接実装
                const gameOverEditorBtn = document.getElementById('btn-game-over-editor');
                
                if (gameOverEditorBtn) {
                    console.log('🛠️ ゲーム終了画面編集ボタンを直接設定');
                    
                    gameOverEditorBtn.addEventListener('click', function(event) {
                        event.preventDefault();
                        event.stopPropagation();
                        
                        console.log('🛠️ ゲーム終了画面編集ボタンがクリックされました');
                        
                        // 効果音再生
                        if (window.gameController && window.gameController.audioManager) {
                            window.gameController.audioManager.playSE('se_click.mp3', 0.7).catch(() => {});
                        }
                        
                        // ゲームコントローラーが初期化されているか確認
                        if (window.gameController && window.gameController.isInitialized) {
                            showGameOverEditor();
                        } else {
                            console.warn('ゲームコントローラーが未初期化です');
                            alert('ゲームがまだ読み込み中です。しばらくお待ちください。');
                        }
                    });
                    
                    console.log('✅ ゲーム終了画面編集ボタンの直接実装完了');
                } else {
                    console.warn('❌ ゲーム終了画面編集ボタンが見つかりません');
                }
            }, 1000);
        });
        
        /**
         * 🏆 直接エンディングトークを表示（勝利後トーク）
         */
        function showVictoryTalkDirectly() {
            console.log('🏆 直接エンディングトークを表示します');
            
            try {
                // ゲームコントローラーの参照を取得
                const game = window.gameController;
                
                if (!game || !game.scenes || !game.scenes.title) {
                    throw new Error('ゲームコンポーネントが初期化されていません');
                }
                
                // タイトル画面を非表示
                if (game.scenes.title.isActive) {
                    game.scenes.title.hide();
                }
                
                // ゲーム状態を勝利後トーク用にセット
                if (game.gameState) {
                    game.gameState.isGameActive = false;
                    game.gameState.currentPhase = 'victory_talk';
                    // プレイヤーが5勝した状態をシミュレート
                    game.gameState.playerWins = 5;
                    game.gameState.misakiWins = 0;
                    console.log('🏆 ゲーム状態を勝利状態に設定完了');
                }
                
                // 直接勝利後トークを表示（'victory'シーン）
                game.showDialogue('victory');
                console.log('✅ エンディングトーク表示完了');
                
            } catch (error) {
                console.error('❌ エンディングトーク表示エラー:', error);
                
                // フォールバック：通常の会話シーンを表示
                try {
                    if (window.gameController) {
                        window.gameController.showDialogue('living');
                        console.log('🛠️ フォールバック: 通常の会話シーンを表示');
                    } else {
                        alert('エラーが発生しました。ページを再読み込みしてください。');
                    }
                } catch (fallbackError) {
                    console.error('❌ フォールバックエラー:', fallbackError);
                    alert('重大なエラーが発生しました。ページを再読み込みしてください。');
                }
            }
        }
        
        /**
         * 🛠️ ゲーム終了画面編集システムを表示
         */
        function showGameOverEditor() {
            console.log('🛠️ ゲーム終了画面編集システムを表示します');
            
            try {
                // ゲームコントローラーの参照を取得
                const game = window.gameController;
                
                if (!game || !game.scenes) {
                    throw new Error('ゲームコンポーネントが初期化されていません');
                }
                
                // GameOverEditorSceneが存在しない場合は作成
                if (!game.scenes.gameOverEditor) {
                    console.log('🆕 GameOverEditorSceneを新規作成');
                    game.scenes.gameOverEditor = new GameOverEditorScene(game);
                }
                
                // エディター画面を表示
                game.scenes.gameOverEditor.show();
                
                console.log('✅ ゲーム終了画面編集システム表示完了');
                
            } catch (error) {
                console.error('❌ ゲーム終了画面編集システム表示エラー:', error);
                
                // フォールバックメッセージ
                alert('エラーが発生しました。\n\n' + 
                      'ゲームが完全に読み込まれていない可能性があります。\n' + 
                      'ページを再読み込みしてから再度お試しください。');
            }
        }
    </script>
</body>
</html>