<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>2人の秘密、野球拳。</title>
    <link rel="stylesheet" href="./src/styles/main.css?v=2025091502">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- 即座再生用の隠し音声要素 -->
    <audio id="immediate-bgm" preload="auto" loop style="display:none;">
        <source src="./assets/audio/bgm/bgm_title.mp3" type="audio/mpeg">
    </audio>

    <!-- 🎮 ブラウザ版環境設定（Electron版と同じ動作を実現） -->
    <script>
        (function() {
            console.log('🌐 ブラウザ版環境設定開始');

            // 🔧 安全なElectron環境検出（process変数エラー回避）
            let isElectron = false;
            try {
                // window.electronAPIやrequireが存在するかチェック
                isElectron = !!(window.electronAPI || window.require);

                // processオブジェクトを安全にチェック
                if (!isElectron && typeof process !== 'undefined' && process.versions && process.versions.electron) {
                    isElectron = true;
                }
            } catch (error) {
                // ブラウザ環境ではprocessが未定義のため、エラーは無視
                console.log('🌐 ブラウザ環境確定（processオブジェクト未定義）');
                isElectron = false;
            }

            if (!isElectron) {
                console.log('🌐 ブラウザ環境検出：制限付き自動再生モード');

                // ブラウザ版では即座再生を無効化してAudioManagerに統一
                window.BROWSER_AUTOPLAY_RESTRICTED = true;

                // AudioContextの準備（Electron版と同様）
                if (window.AudioContext || window.webkitAudioContext) {
                    console.log('🎵 AudioContext準備完了（ブラウザ版）');
                }
            } else {
                console.log('🎮 Electron環境検出：完全自動再生モード');
                window.ELECTRON_AUTOPLAY_ENABLED = true;
            }

            console.log('✅ 環境設定完了:', {
                isElectron,
                browserRestricted: window.BROWSER_AUTOPLAY_RESTRICTED,
                electronEnabled: window.ELECTRON_AUTOPLAY_ENABLED
            });
        })();
    </script>

    <!-- 即座BGM再生スクリプト（BGM重複防止のため無効化） -->
    <script>
        // HTMLロード直後に即座にBGM再生を試行（無効化）
        (function() {
            console.log('🚫 即座BGM再生システム無効化（AudioManagerに統一）');
            return; // BGM重複防止のため早期リターン

            const bgm = document.getElementById('immediate-bgm');
            if (!bgm) {
                console.error('❌ immediate-bgm要素が見つかりません');
                return;
            }

            // BGM要素の初期設定
            bgm.volume = 0.5;
            bgm.muted = false;

            let isPlaying = false; // 再生状態フラグ

            // BGM再生関数
            const playBGM = () => {
                if (isPlaying) return; // 既に再生中の場合は何もしない

                try {
                    const playPromise = bgm.play();
                    if (playPromise !== undefined) {
                        playPromise.then(() => {
                            console.log('✅ 即座BGM再生成功！');
                            isPlaying = true;

                            // AudioManagerと同期（遅延実行）
                            setTimeout(() => {
                                try {
                                    if (window.gameController && window.gameController.audioManager) {
                                        window.gameController.audioManager.bgmAudio = bgm;
                                        window.gameController.audioManager.currentBgm = 'bgm_title.mp3';
                                        window.gameController.audioManager.isInitialized = true;
                                        console.log('🔗 AudioManagerと同期完了');
                                    }
                                } catch (syncError) {
                                    console.log('⚠️ AudioManager同期エラー:', syncError.message);
                                }
                            }, 1000);
                        }).catch(error => {
                            console.log('⚠️ 即座BGM再生待機中:', error.message);

                            // 一度だけユーザーインタラクションイベントを設定
                            if (!window.bgmInteractionListenersSet) {
                                const events = ['click', 'keydown', 'touchstart'];
                                events.forEach(eventType => {
                                    document.addEventListener(eventType, () => {
                                        if (!isPlaying) playBGM();
                                    }, { once: true, passive: true });
                                });
                                window.bgmInteractionListenersSet = true;
                            }
                        });
                    }
                } catch (error) {
                    console.log('⚠️ BGM再生関数エラー:', error.message);
                }
            };

            // 即座実行
            playBGM();

            // 遅延実行（制限付き）
            let retryCount = 0;
            const maxRetries = 3;

            [100, 500, 1000].forEach(delay => {
                setTimeout(() => {
                    if (!isPlaying && bgm.paused && retryCount < maxRetries) {
                        console.log(`🔄 BGM再試行 (${delay}ms後) - ${retryCount + 1}/${maxRetries}`);
                        retryCount++;
                        playBGM();
                    }
                }, delay);
            });

        })();
    </script>

    <!-- グローバルBGM制御関数（重複防止） -->
    <script>
        // グローバルBGM停止関数
        window.stopAllBGM = function() {
            console.log('🛑 グローバルBGM停止実行');

            // HTML側のBGMを停止
            const immediateBgm = document.getElementById('immediate-bgm');
            if (immediateBgm && !immediateBgm.paused) {
                immediateBgm.pause();
                immediateBgm.currentTime = 0;
                console.log('🛑 immediate-bgmを停止');
            }

            // AudioManagerのBGMも停止
            if (window.gameController && window.gameController.audioManager) {
                window.gameController.audioManager.stopBGM(0);
                console.log('🛑 AudioManagerのBGMを停止');
            }

            // 全てのaudio要素を停止
            const allAudio = document.querySelectorAll('audio');
            allAudio.forEach((audio, index) => {
                if (!audio.paused) {
                    audio.pause();
                    audio.currentTime = 0;
                    console.log(`🛑 audio要素[${index}]を停止`);
                }
            });

            console.log('✅ 全BGM停止完了');
        };

        // AudioManagerが利用可能になったときの連携設定
        window.addEventListener('load', () => {
            // 定期的にAudioManagerとの同期をチェック
            setInterval(() => {
                if (window.gameController && window.gameController.audioManager) {
                    // AudioManagerのstopBGMメソッドにHTML側の停止も組み込み済み
                }
            }, 1000);
        });
    </script>

    <div id="game-container">
        <!-- ローディング画面 -->
        <div id="loading-screen" class="screen active">
            <div class="loading-content">
                <h1>2人の秘密、野球拳。</h1>
                <div class="loading-spinner"></div>
                <p>Loading...</p>
            </div>
        </div>

        <!-- タイトル画面 -->
        <div id="title-screen" class="screen">
            <div class="background" id="title-bg"></div>
            <div class="title-content">
                <!-- 左側：美咲の立ち絵表示エリア -->
                <div class="misaki-display">
                    <img id="misaki-title" src="assets/images/characters/misaki/misaki_adult_normal.png" alt="美咲お姉ちゃん">
                </div>

                <!-- 右側：タイトルとメニュー -->
                <div class="title-main-content">
                    <div class="game-logo">
                        <h1>2人の秘密、野球拳。</h1>
                        <div class="subtitle">～大人になった二人の秘密～</div>
                    </div>
                    
                    <div class="menu-buttons">
                        <button class="game-btn" id="btn-new-game">はじめる</button>
                        <button class="game-btn" id="btn-howtoplay">遊び方</button>
                        <button class="game-btn" id="btn-gallery">ギャラリー</button>
                        <button class="game-btn" id="btn-settings">設定</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 会話シーン -->
        <div id="dialogue-screen" class="screen">
            <div class="background" id="dialogue-bg"></div>
            <button class="return-to-title-btn" id="dialogue-return-btn">タイトルへ戻る</button>
            <div class="misaki-large-display">
                <img id="misaki-dialogue" src="assets/images/characters/misaki/misaki_dialogue_normal.png" alt="美咲">
            </div>
            <div class="dialogue-box">
                <div class="character-name">美咲</div>
                <div class="dialogue-text" id="dialogue-text"></div>
                <div class="dialogue-controls">
                    <button class="control-btn" id="btn-skip">Skip</button>
                    <button class="control-btn" id="btn-auto">Auto</button>
                </div>
            </div>
        </div>

        <!-- メインゲーム画面 -->
        <div id="game-screen" class="screen">
            <div class="background" id="game-bg"></div>
            <button class="return-to-title-btn" id="game-return-btn">タイトルへ戻る</button>
            
            <!-- 上部ステータス -->
            <div class="status-top">
                <div class="round-info">ラウンド <span id="current-round">1</span>/9</div>
                <div class="win-condition">勝利条件: 5勝先取</div>
            </div>

            <!-- 美咲のハート表示（ラウンド表示の下） -->
            <div class="misaki-hearts-display" id="misaki-hearts-display">
                <div class="hearts-container" id="misaki-hearts-container"></div>
            </div>

            <!-- 美咲のステータスとHP -->
            <div class="misaki-status">
                <div class="character-name">美咲</div>
                <div class="hp-display">
                    <div class="hp-bar-container">
                        <div class="hp-bar-label">ライフ</div>
                        <div class="hp-bar">
                            <div class="hp-bar-fill" id="misaki-hp-bar"></div>
                            <div class="hp-bar-text" id="misaki-hp-text">5/5</div>
                        </div>
                    </div>
                    <div class="defeat-count">敗北数: <span id="misaki-defeats">0</span></div>
                </div>
            </div>

            <!-- 美咲の大型立ち絵表示 -->
            <div class="misaki-game-display">
                <img id="misaki-game" src="assets/images/characters/misaki/misaki_game_stage1.png" alt="美咲">
            </div>

            <!-- ゲーム開始前の会話 -->
            <div class="game-intro" id="game-intro">
                <div class="intro-dialogue" id="intro-dialogue">
                    <div class="dialogue-text" id="game-dialogue-text">
                        <!-- タイプライター効果で表示されます -->
                    </div>
                </div>
            </div>

            <!-- ゲーム開始ボタン（独立配置） -->
            <div class="start-game-button-container" style="display: none;">
                <button class="hand-btn advance-btn" id="start-game-btn">
                    <span style="font-size: 2em;">🎮</span>
                    <span>ゲーム開始</span>
                </button>
            </div>

            <!-- バトル結果表示 -->
            <div class="battle-result" id="battle-result">
                <div class="result-text" id="result-text"></div>
                <div class="hands-display">
                    <div class="hand-result">美咲: <span id="misaki-hand"></span></div>
                    <div class="vs">VS</div>
                    <div class="hand-result">あなた: <span id="player-hand"></span></div>
                </div>
            </div>

            <!-- じゃんけんアニメーション表示 -->
            <div class="janken-animation" id="janken-animation">
                <div class="animation-overlay"></div>
                <div class="hands-battle">
                    <div class="player-hand-display">
                        <div class="hand-label">あなた</div>
                        <div class="hand-image" id="player-hand-image">
                            <img src="" alt="" id="player-hand-img">
                        </div>
                        <div class="hand-effect" id="player-hand-effect"></div>
                    </div>
                    <div class="vs-display">
                        <div class="vs-text" id="vs-text">VS</div>
                        <div class="battle-sparks"></div>
                        <div class="impact-burst" id="impact-burst"></div>
                    </div>
                    <div class="misaki-hand-display">
                        <div class="hand-label">美咲</div>
                        <div class="hand-image" id="misaki-hand-image">
                            <img src="" alt="" id="misaki-hand-img">
                        </div>
                        <div class="hand-effect" id="misaki-hand-effect"></div>
                    </div>
                </div>
                <div class="result-display" id="animated-result">
                    <div class="result-text-animated" id="result-text-animated"></div>
                    <div class="result-subtitle" id="result-subtitle"></div>
                </div>
            </div>

            <!-- プレイヤーのステータス -->
            <div class="player-status">
                <div class="character-name">あなた</div>
                <div class="hp-display">
                    <div class="hp-bar-container">
                        <div class="hp-bar-label">ライフ</div>
                        <div class="hp-bar">
                            <div class="hp-bar-fill player-hp" id="player-hp-bar"></div>
                            <div class="hp-bar-text" id="player-hp-text">5/5</div>
                        </div>
                    </div>
                    <div class="victory-count">勝利数: <span id="player-victories">0</span></div>
                </div>
            </div>

            <!-- プレイヤーのハート表示 -->
            <div class="player-hearts-display" id="player-hearts-display">
                <div class="hearts-container" id="player-hearts-container"></div>
            </div>

            <!-- じゃんけん選択ボタン -->
            <div class="janken-controls">
                <div class="hand-buttons">
                    <button class="hand-btn" id="btn-rock">
                        <img src="assets/images/ui/rock.png" alt="グー">
                        <span>グー</span>
                    </button>
                    <button class="hand-btn" id="btn-scissors">
                        <img src="assets/images/ui/scissors.png" alt="チョキ">
                        <span>チョキ</span>
                    </button>
                    <button class="hand-btn" id="btn-paper">
                        <img src="assets/images/ui/paper.png" alt="パー">
                        <span>パー</span>
                    </button>
                </div>
                <div class="instruction">選択してください</div>
            </div>

            <!-- 進めるボタン（じゃんけんボタンと同じ高さ、初期は非表示） -->
            <div class="advance-button-container" style="display: none;">
                <button class="hand-btn advance-btn" id="btn-advance">
                    <span style="font-size: 2em;">▶️</span>
                    <span>進める</span>
                </button>
            </div>

            <!-- ゲーム制御ボタン -->
            <div class="game-controls">
                <button class="control-btn" id="btn-hint">ヒント</button>
                <button class="control-btn" id="btn-surrender">降参</button>
            </div>
        </div>

        <!-- エンディング画面 -->
        <div id="ending-screen" class="screen">
            <div class="background" id="ending-bg"></div>
            <button class="return-to-title-btn" id="ending-return-btn">タイトルへ戻る</button>
            <div class="ending-content">
                <div class="ending-title" id="ending-title"></div>
                <div class="ending-character">
                    <img id="ending-character-sprite" src="" alt="立ち絵" style="display: none;">
                </div>
                <div class="ending-cg">
                    <img id="ending-image" src="" alt="エンディング">
                </div>
                <div class="ending-text" id="ending-text"></div>
                <div class="ending-controls">
                    <button class="game-btn" id="btn-title-return">タイトルに戻る</button>
                    <button class="game-btn" id="btn-replay">もう一度プレイ</button>
                </div>
            </div>
        </div>

    </div>

    <!-- JavaScript -->
    <script src="assets/data/gallery_data.js?v=2025091503"></script>
    <script src="src/systems/CSVLoader.js?v=2025091503"></script>
    <script src="src/systems/SaveSystem.js?v=2025091503"></script>
    <script src="src/systems/AudioManager.js?v=2025091503"></script>
    <script src="src/systems/ClickSoundManager.js?v=2025091503"></script>
    <script src="src/systems/CostumeSystem.js?v=2025091503"></script>
    <script src="src/scenes/TitleScene.js?v=2025091503"></script>
    <script src="src/scenes/DialogueScene.js?v=2025091505"></script>
    <script src="src/scenes/GameScene.js?v=2025091503"></script>
    <script src="src/scenes/EndingScene.js?v=2025091503"></script>
    <script src="src/scenes/GalleryScene.js?v=2025091503"></script>
    <script src="src/game.js?v=2025091503"></script>
    
</body>
</html>